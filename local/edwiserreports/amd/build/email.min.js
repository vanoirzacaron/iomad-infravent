"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}define(["jquery","core/notification","core/modal_factory","core/fragment","core/modal_events","./common","./variables"],function(e,t,a,o,r,i,n){var l=null,d="#scheduletab",s={DROPDOWNS:d+" .dropdown a.dropdown-item",DROPDOWNSELECTOR:"button.dropdown-toggle",DURATIONSELECTOR:d+" .dropdown.duration-dropdown a.dropdown-item",DURATIONINPUT:d+' input[name="esrduration"]',TIMESDROPDOWNBTN:d+" .date-filters .dropdown:not(.duration-dropdown) button.dropdown-toggle",TIMESDROPDOWNLINK:d+" .date-filters .dropdown:not(.duration-dropdown) a.dropdown-item",DAILYDROPDOWNBTN:d+" .dropdown.daily-dropdown button.dropdown-toggle",WEEKLYDROPDOWNBTN:d+" .dropdown.weekly-dropdown button.dropdown-toggle",MONTHLYDROPDOWNBTN:d+" .dropdown.monthly-dropdown button.dropdown-toggle",TIMEINPUT:d+' input[name="esrtime"]',FORMATSELECTOR:d+" .dropdown.format-dropdown a.dropdown-item",EDITBTN:"#listemailstab .esr-email-sched-edit",DELETEBTN:"#listemailstab .esr-email-sched-delete",EMAILLISTTOGGLESWITCH:"#listemailstab .esr-email-toggle",TABS:'[data-plugin="tabs"] .nav-link, [data-plugin="tabs"] .tab-pane',FORMTAB:'[aria-controls="scheduletab"], #scheduletab',FORMLISTTAB:'[href="#listemailstab"]',LISTSEARCH:"#listemailstab .table-search-input input",SCHEDULEDEMAILDROPDOWN:'.download-links button[value="email"]',ID:'[name="esrid"]',NAME:'[name="esrname"]',SUBJECT:'[name="esrsubject"]',RECEPIENT:'[name="esrrecepient"]',BLOCKNAME:'[name="blockname"]',REGION:'[name="region"]',FILTERDATA:'[name="esrfilterdata"]',FORMAT:'[name="esrformat"]',GRAPHICAL:'[name="esrgraphical"]',RESET:'[data-action="reset"]',SAVE:'[data-action="save"]',SEND:'[data-action="send"]'},c=/^[a-zA-Z0-9]+[a-zA-Z0-9+_.-]+[a-zA-Z0-9]+@[a-zA-Z0-9]+[a-zA-Z0-9.-]*\.[a-zA-Z]{2,}$/;function u(t,a){var o=a.getRoot().find("#esr-shceduled-emails");return e(document).on("click",s.FORMLISTTAB,function(){e(window).resize()}),o.DataTable({ajax:{url:n.requestUrl+"?sesskey="+t.sesskey,type:n.requestType,data:{action:"get_scheduled_emails_ajax",data:JSON.stringify({blockname:t.block,region:t.region})}},dom:'<"edwiserreports-table"i<t><"table-pagination"p>>',language:{info:M.util.get_string("tableinfo","local_edwiserreports"),infoEmpty:M.util.get_string("infoempty","local_edwiserreports"),emptyTable:M.util.get_string("noscheduleemails","local_edwiserreports"),zeroRecords:M.util.get_string("zerorecords","local_edwiserreports"),sClass:"text-center",paginate:{previous:" ",next:" "}},drawCallback:function(){i.stylePaginationButton(this)},order:[[2,"asc"]],columns:[{data:"esrname",orderable:!0},{data:"esrnextrun",orderable:!0},{data:"esrfrequency",orderable:!0},{data:"esrmanage",orderable:!1}],responsive:!0,lengthChange:!1})}function f(a,o){var r=e(a).data("id"),i=e(a).data("blockname"),l=e(a).data("region");e.ajax({url:n.requestUrl,type:n.requestType,sesskey:e(a).data("sesskey"),data:{action:"get_scheduled_email_detail_ajax",sesskey:e(a).data("sesskey"),data:JSON.stringify({id:r,blockname:i,region:l})}}).done(function(t){(t=JSON.parse(t)).error?console.log(t):(!function(t,a,o){var r=null,i=null;e.each(t.data,function(e,t){if("object"===_typeof(t))return o.find(s.BLOCKNAME).val(t.blockname),void o.find(s.REGION).val(t.region);switch(e){case"esrduration":r=t,o.find('.duration-dropdown .dropdown-item[data-value="'+t+'"]').click();case"esrtime":i=t;break;case"esremailenable":case"esrfilterdata":o.find('input[name="'+e+'"]').prop("checked",t);break;case"esrformat":o.find('.format-dropdown .dropdown-item[data-value="'+t+'"]').click();break;default:o.find('[name="'+e+'"]').val(t).length&&o.find('[name="'+e+'"]').trigger("input")}}),void 0===t.data.esrfilterdata&&o.find(s.FILTERDATA).prop("checked",!0);if(void 0===t.data.esrformat){var n=1==o.find(s.GRAPHICAL).val()?"pdfimage":"csv";o.find('.format-dropdown .dropdown-item[data-value="'+n+'"]').click()}var l='.dropdown-item[data-value="'+i+'"]',d=null;switch(r){case"1":d=e(".weekly-dropdown");break;case"2":d=e(".monthly-dropdown");break;default:d=e(".daily-dropdown")}d.find(l).click()}(t,0,o),o.find(s.TABS).removeClass("active show"),o.find(s.FORMTAB).addClass("active show"))}).fail(t.exception)}function m(a,o,r){o.on("click",s.EDITBTN,function(){f(this,o)}),o.on("click",s.DELETEBTN,function(d){a.id=e(this).data("id"),t.confirm(M.util.get_string("confirmemailremovaltitle","local_edwiserreports"),M.util.get_string("confirmemailremovalquestion","local_edwiserreports"),M.util.get_string("yes","moodle"),M.util.get_string("no","moodle"),e.proxy(function(){!function(a,o,r){var d=a.id,s=a.block,c=a.region,f=o.find(".esr-form-error");i.loader.show("body"),e.ajax({url:n.requestUrl,type:n.requestType,sesskey:a.sesskey,data:{action:"delete_scheduled_email_ajax",sesskey:a.sesskey,data:JSON.stringify({id:d,blockname:s,region:c})}}).done(function(e){e.error?f.html(M.util.get_string("deleteerrormsg","local_edwiserreports")):(l&&l.destroy(),l=u(a,r),f.html(M.util.get_string("deletesuccessmsg","local_edwiserreports")))}).fail(t.exception).always(function(){f.delay(3e3).fadeOut("slow"),i.loader.hide("body")})}(a,o,r)},d.currentTarget))}),o.on("click",s.EMAILLISTTOGGLESWITCH,function(){a.id=e(this).data("id"),function(t,a,o){var r=t.id,i=t.block,l=t.region,d=t.sesskey,s=a.find(".esr-form-error");e.ajax({url:n.requestUrl,type:n.requestType,data:{action:"change_scheduled_email_status_ajax",sesskey:d,data:JSON.stringify({id:r,blockname:i,region:l})}}).done(function(e){var o=a.find('.esr-manage-scheduled-emails .esr-switch[data-id="'+t.id+'"]');e=JSON.parse(e),"0"==o.attr("data-value")?o.attr("data-value","on"):o.attr("data-value","0"),e.error?(s.html(e.errormsg),s.show(),s.delay(3e3).fadeOut("slow")):(s.html(e.successmsg),s.show(),s.delay(3e3).fadeOut("slow"))})}(a,o)})}function p(a,o,r){o.on("click",s.DROPDOWNS,function(){var t,a,o,r;a=e(t=this).data("value"),o=e(t).text(),(r=e(t).closest(".dropdown").find(s.DROPDOWNSELECTOR)).text(o),r.data("value",a)}),o.on("click",s.DURATIONSELECTOR,function(){!function(t,a){var o=e(t).data("value");a.find(s.DURATIONINPUT).val(o),e(s.TIMESDROPDOWNBTN).hide();var r=null;switch(o){case 1:r=e(s.WEEKLYDROPDOWNBTN);break;case 2:r=e(s.MONTHLYDROPDOWNBTN);break;default:r=e(s.DAILYDROPDOWNBTN)}r.show();var i=r.data("value");e(s.TIMEINPUT).val(i)}(this,o)}),o.on("click",s.TIMESDROPDOWNLINK,function(){o.find(s.TIMEINPUT).val(e(this).data("value"))}),o.on("click",s.FORMATSELECTOR,function(){o.find(s.FORMAT).val(e(this).data("value"))}),o.on("click",s.SAVE,function(){var n=o.find(".esr-form-error");if(i.loader.show("body"),function(e,t){var a=e.find(s.NAME).val(),o=e.find(s.SUBJECT).val(),r=!0;return""!=a&&""!=o||(t.html(M.util.get_string("emptyerrormsg","local_edwiserreports")).show(),r=!1),g(e.find(s.RECEPIENT).val())||(r=!1,t.html(M.util.get_string("emailinvaliderrormsg","local_edwiserreports")).show()),r}(o.find("form"),n)){var d=a.filter,c=a.cohortid,f=a.block,m=M.cfg.wwwroot+"/local/edwiserreports/download.php?type=emailscheduled&filter="+d+"&cohortid="+c+"&block="+f;e.ajax({url:m,type:"POST",data:o.find("form").serialize()}).done(function(t){(t=e.parseJSON(t)).error?(n.html(M.util.get_string("scheduleerrormsg","local_edwiserreports")).show(),console.log(t.error)):(l&&l.destroy(),l=u(a,r),n.html(M.util.get_string("schedulesuccessmsg","local_edwiserreports")).show())}).fail(t.exception).always(function(){setTimeout(function(){n.fadeOut("slow")},3e3),i.loader.hide("body")})}else i.loader.hide("body")}),o.on("click",s.SEND,function(){!function(t,a,o){var r=t.filter,n=t.cohortid,l=t.block,d=o.find(".esr-form-error");d.html("").show(),i.loader.show(o.closest(".modal"),"position-fixed"),e.ajax({url:M.cfg.wwwroot+"/local/edwiserreports/download.php?type=email&filter="+r+"&cohortid="+n+"&block="+l,type:"POST",data:o.find("form").serialize()}).done(function(t){(t=e.parseJSON(t)).error?d.html('<div class="alert alert-danger"><b>ERROR:</b>'+t.errormsg+"</div>"):d.html('<div class="alert alert-success"><b>Success:</b>'+t.errormsg+"</div>")}).fail(function(e){d.html('<div class="alert alert-danger"><b>ERROR:</b>'+e.errormsg+"</div>")}).always(function(){d.delay(3e3).fadeOut("slow"),i.loader.hide(o.closest(".modal"))})}(a,0,o)}),o.on("click",s.RESET,function(){o.find('[type="text"], textarea').val("").trigger("input");var t=o.find(".format-dropdown .dropdown-item");console.log(t),t.closest('[data-value="csv"]').length?t.closest('[data-value="csv"]').trigger("click"):t.closest('[data-value="pdfimage"]').trigger("click"),e(".date-filters .dropdown .dropdown-item:nth-child(1)").trigger("click"),o.find('[type="checkbox"]').prop("checked",!0).each(function(t,a){e(a).trigger("input")}),o.find(s.ID).val(-1)})}function g(t){var a,o=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=!0,i=e(s.RECEPIENT).get(0),n=[];return t.replaceAll(" ","").replaceAll(";",",").split(",").forEach(function(e){null!=n[e]&&(a=!0),n[e]=!0,r=r&&c.test(e)}),a?(o&&(i.setCustomValidity("Invalid email"),e(i).next().text(M.util.get_string("duplicateemail","local_edwiserreports"))),!1):r?(o&&i.setCustomValidity(""),!0):(""==t?(i.setCustomValidity(""),e(i).next().text("")):o&&(i.setCustomValidity("Invalid email"),e(i).next().text(M.util.get_string("invalidemail","local_edwiserreports"))),!1)}return{init:function(){e(document).on("input",s.RECEPIENT,function(){g(e(this).val())}),e(document).on("input","".concat(s.NAME,", ").concat(s.RECEPIENT,", ").concat(s.SUBJECT),function(){var t=""==e(s.NAME).val(),a=!g(e(s.RECEPIENT).val(),!1),o=""==e(s.SUBJECT).val(),r=t||a||o;e(this).closest(".fitem").addClass("was-validated"),e(d).find("".concat(s.SAVE,", ").concat(s.SEND)).prop("disabled",r),e(d+" .form-group.fitem").toggleClass("disabled",r)}),e(document).on("blur","".concat(s.NAME,", ").concat(s.RECEPIENT,", ").concat(s.SUBJECT),function(){e(this).closest(".fitem").addClass("was-validated")}),e(document).on("click",s.SCHEDULEDEMAILDROPDOWN,function(){var t=n.getScheduledEmailFormContext();t.graphical=e(this).is('[data-type="graphical"]');var i=e(this).closest("form").serializeArray();e(i).each(function(e,a){t[a.name]=a.value});var d=M.util.get_string("scheduleemailfor","local_edwiserreports");t.block.includes("customreportsblock")?d+=" "+e("#"+t.block).data("blockname"):d+=" "+M.util.get_string(t.block+"exportheader","local_edwiserreports"),a.create({title:d,body:o.loadFragment("local_edwiserreports","email_schedule_tabs",1,{data:JSON.stringify(t)})}).done(function(e){var a=e.getRoot();a.find(".modal-header").addClass("border-bottom-0"),a.find(".modal-title").addClass("h4 font-weight-600"),e.modal.addClass("modal-lg"),a.on(r.bodyRendered,function(){a.find(s.BLOCKNAME).val(t.blockname),a.find(s.REGION).val(t.region),a.find('[name="sesskey"]').val(t.sesskey),l=u(t,e)}),a.on(r.hidden,function(){e.destroy()}),p(t,a,e),m(t,a,e),e.show()})}),e(document).on("input",s.LISTSEARCH,function(){l.search(this.value).draw()})}}});
//# sourceMappingURL=email.min.js.map
