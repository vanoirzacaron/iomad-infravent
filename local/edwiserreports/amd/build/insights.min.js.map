{"version":3,"sources":["insights.js"],"names":["define","$","Templates","common","CFG","SELECTOR","CONTAINER","INSIGHT","ONLYINSIGHT","INSIGHT_WRAP","MOVELEFT","MOVERIGHT","HIDE","INSIGHT_ADD_CARD","INSIGHT_DROPDOWNMENU","INSIGHT_ITEM","filter","PROMISE","GET_INSIGHT_CARD_CONTEXT","id","ajax","url","requestUrl","type","requestType","dataType","requestDataType","data","action","secret","M","local_edwiserreports","lang","attr","JSON","stringify","GET_INSIGHT_CARD_DATA","updateOrder","order","loader","show","each","index","insight","push","util","set_user_preference","hide","updateInsight","rtl","done","response","value","timeFormatter","dataPointIndex","short","replaceAll","render","html","js","replaceNode","find","init","document","ready","dateChange","date","on","prev","this","closest","detach","insertBefore","next","insertAfter","prepend","concat","text","remove","then","present","editing","before","runTemplateJS","removeClass"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n/**\n * Page top insight management js.\n *\n * @package     local_edwiserreports\n * @copyright   2021 wisdmlabs <support@wisdmlabs.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n/* eslint-disable no-console */\ndefine([\n    'jquery',\n    'core/templates',\n    './common',\n    './defaultconfig'\n], function(\n    $,\n    Templates,\n    common,\n    CFG\n) {\n\n    /**\n     * Selector for the insights.\n     */\n    let SELECTOR = {\n        CONTAINER: '.top-insights',\n        INSIGHT: '.top-insights .insight',\n        ONLYINSIGHT: '.top-insights .insight:not(.add-insight)',\n        INSIGHT_WRAP: '.insight-wrap',\n        MOVELEFT: '.top-insights .card-editing .move-left',\n        MOVERIGHT: '.top-insights .card-editing .move-right',\n        HIDE: '.top-insights .card-editing .edit-hide',\n        INSIGHT_ADD_CARD: '.top-insights .insight.add-insight',\n        INSIGHT_DROPDOWNMENU: '.top-insights .add-new-insight .dropdown-menu',\n        INSIGHT_ITEM: '.top-insights .add-new-insight .dropdown-item'\n    };\n\n    /**\n     * Filter object.\n     */\n    let filter = null;\n\n    /**\n     * Promise list.\n     */\n    let PROMISE = {\n        /**\n         * Get insight card data to render insight card.\n         * @param {String} id Insight id\n         * @returns {Promise}\n         */\n        GET_INSIGHT_CARD_CONTEXT: function(id) {\n            return $.ajax({\n                url: CFG.requestUrl,\n                type: CFG.requestType,\n                dataType: CFG.requestDataType,\n                data: {\n                    action: 'get_insight_card_context_ajax',\n                    secret: M.local_edwiserreports.secret,\n                    lang: $('html').attr('lang'),\n                    data: JSON.stringify({\n                        id: id\n                    })\n                },\n            });\n        },\n\n        /**\n         * Get insight card data to render insight details.\n         * @param {String} id Insight id\n         * @return {Promise}\n         */\n        GET_INSIGHT_CARD_DATA: function(id) {\n            return $.ajax({\n                url: CFG.requestUrl,\n                type: CFG.requestType,\n                dataType: CFG.requestDataType,\n                data: {\n                    action: 'get_insight_card_data_ajax',\n                    secret: M.local_edwiserreports.secret,\n                    lang: $('html').attr('lang'),\n                    data: JSON.stringify({\n                        id: id,\n                        filter: filter\n                    })\n                },\n            });\n        }\n    };\n\n    /**\n     * Update insight order in the user preference.\n     */\n    function updateOrder() {\n        let order = [];\n        common.loader.show(SELECTOR.CONTAINER);\n        $(SELECTOR.ONLYINSIGHT).each(function(index, insight) {\n            order.push($(insight).data('id'));\n        });\n        M.util.set_user_preference('local_edwiserreports_insights_order', JSON.stringify(order));\n        common.loader.hide(SELECTOR.CONTAINER);\n    }\n\n    /**\n     * Update insight card details.\n     * @param {String} id Insight id\n     */\n    function updateInsight(id) {\n\n        var rtl = $('html').attr('dir');\n        rtl = rtl == 'rtl' ? 1 : 0;\n\n        common.loader.show(SELECTOR.CONTAINER + ' [data-id=\"' + id + '\"] .insight-wrapper');\n        PROMISE.GET_INSIGHT_CARD_DATA(id, filter)\n            .done(function(response) {\n                switch (id) {\n                    case 'timespentoncourses':\n                    case 'timespentonsite':\n                        response.value = '<span style=\"direction:ltr;\">' + common.timeFormatter(response.value, {\n                            dataPointIndex: 0,\n                            short: true\n                        }, rtl).replaceAll(', ', ' ') + '</span>';\n                        break;\n                }\n                Templates.render('local_edwiserreports/insights/content', response)\n                    .done(function(html, js) {\n                        Templates.replaceNode($(SELECTOR.INSIGHT + '[data-id=\"' + id + '\"]')\n                            .find(SELECTOR.INSIGHT_WRAP), html, js);\n                        common.loader.hide(SELECTOR.CONTAINER + ' [data-id=\"' + id + '\"] .insight-wrapper');\n                    });\n            });\n    }\n\n    /**\n     * Initialize events.\n     */\n    function initEvents() {\n        // Date selector listener.\n        common.dateChange(function(date) {\n            filter = date;\n            $(SELECTOR.ONLYINSIGHT).each(function(index, insight) {\n                updateInsight($(insight).data('id'));\n            });\n        });\n\n        // Move left.\n        $('body').on('click', SELECTOR.MOVELEFT, function() {\n            let prev = $(this).closest(SELECTOR.INSIGHT).prev();\n            $(this).closest(SELECTOR.INSIGHT).detach().insertBefore(prev);\n            updateOrder();\n        });\n\n        // Move Right.\n        $('body').on('click', SELECTOR.MOVERIGHT, function() {\n            let next = $(this).closest(SELECTOR.INSIGHT).next();\n            $(this).closest(SELECTOR.INSIGHT).detach().insertAfter(next);\n            updateOrder();\n        });\n\n        // Hide insight.\n        $('body').on('click', SELECTOR.HIDE, function() {\n            let insight = $(this).closest(SELECTOR.INSIGHT);\n            $(SELECTOR.INSIGHT_DROPDOWNMENU)\n                .prepend(`<a class=\"dropdown-item\" href=\"#\" data-id=\"${insight.data('id')}\">${insight.find('.insight-title').text()}</a>`);\n            insight.remove();\n            updateOrder();\n        });\n\n        // Add insight.\n        $('body').on('click', SELECTOR.INSIGHT_ITEM, function() {\n            let id = $(this).data('id');\n            common.loader.hide(SELECTOR.CONTAINER);\n            PROMISE.GET_INSIGHT_CARD_CONTEXT(id).then(function(response) {\n                if (response.present == true) {\n                    response.editing = true;\n                    Templates.render('local_edwiserreports/insights/insight', response).done(function(html, js) {\n                        $(SELECTOR.INSIGHT_ADD_CARD).before(html);\n                        Templates.runTemplateJS(js);\n                        $(SELECTOR.INSIGHT_ITEM + '[data-id=\"' + id + '\"]').remove();\n                        updateOrder();\n                        updateInsight(id);\n                    });\n                }\n            });\n        });\n    }\n\n    /**\n     * Initialize.\n     */\n    function init() {\n        $(document).ready(function() {\n            filter = $('.edwiserreports-calendar + .dropdown-menu .dropdown-item.active').data('value')\n            initEvents();\n            $(SELECTOR.ONLYINSIGHT).each(function(index, insight) {\n                updateInsight($(insight).data('id'));\n            });\n            $(SELECTOR.CONTAINER).find('.overflow-hidden').removeClass('overflow-hidden');\n        });\n    }\n    return {\n        init: init\n    }\n});\n"],"file":"insights.min.js"}
