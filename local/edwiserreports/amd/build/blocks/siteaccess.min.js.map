{"version":3,"sources":["blocks/siteaccess.js"],"names":["define","$","ApexCharts","common","CFG","EdwiserReportsEvents","SELECTOR","PANEL","GRAPH","SHADES","blockName","PROMISE","GET_VISITSONSITE","ajax","url","requestUrl","type","requestType","dataType","requestDataType","data","action","secret","M","local_edwiserreports","lang","attr","chart","heatmapChart","series","id","height","toolbar","show","stroke","curve","colors","width","xaxis","categories","util","get_string","dataLabels","enabled","getColorTheme","loadGraph","invalidUser","loader","done","response","error","exception","errorcode","Object","assign","siteaccess","reverse","graph","destroy","get","render","setTimeout","hide","renderGraph","find","fail","init","length","opacity","index","append","concat","css","generateShades","document","on","EXPORTGRAPHPDF","graphElement","exportGraphPDF","EXPORTGRAPHJPEG","exportGraphJPEG","EXPORTGRAPHPNG","exportGraphPNG","EXPORTGRAPHSVG","exportGraphSVG"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n/**\n * Plugin administration pages are defined here.\n *\n * @package     local_edwiserreports\n * @copyright   2021 wisdmlabs <support@wisdmlabs.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n/* eslint-disable no-console */\ndefine('local_edwiserreports/blocks/siteaccess', [\n    'jquery',\n    'local_edwiserreports/vendor/apexcharts',\n    'local_edwiserreports/common',\n    'local_edwiserreports/defaultconfig',\n    'local_edwiserreports/events'\n], function(\n    $,\n    ApexCharts,\n    common,\n    CFG,\n    EdwiserReportsEvents\n) {\n    /**\n     * DOM element selectors list.\n     */\n    let SELECTOR = {\n        PANEL: '#siteaccessblock',\n        GRAPH: '#apex-chart-siteaccess-block',\n        SHADES: '.siteaccess-values-shade .shades'\n    };\n\n    // Block name.\n    let blockName = 'siteaccessblock';\n\n    /**\n     * Promise list.\n     */\n    let PROMISE = {\n        /**\n         * Get site access information.\n         * @returns {PROMISE}\n         */\n        GET_VISITSONSITE: function() {\n            return $.ajax({\n                url: CFG.requestUrl,\n                type: CFG.requestType,\n                dataType: CFG.requestDataType,\n                data: {\n                    action: 'get_siteaccess_data_ajax',\n                    secret: M.local_edwiserreports.secret,\n                    lang: $('html').attr('lang')\n                },\n            });\n        }\n    };\n\n    /**\n     * Chart object.\n     */\n    let chart = null;\n\n    /**\n     * Line chart default config.\n     */\n    const heatmapChart = {\n        series: [],\n        chart: {\n            id: 'siteaccess',\n            height: 500,\n            type: 'heatmap',\n            toolbar: {\n                show: false\n            }\n        },\n        stroke: {\n            show: true,\n            curve: 'smooth',\n            colors: ['rgba(0, 0, 0, 0.2)'],\n            width: 1\n        },\n        xaxis: {\n                \n            categories: [\n                M.util.get_string('week_0', 'local_edwiserreports'),\n                M.util.get_string('week_1', 'local_edwiserreports'),\n                M.util.get_string('week_2', 'local_edwiserreports'),\n                M.util.get_string('week_3', 'local_edwiserreports'),\n                M.util.get_string('week_4', 'local_edwiserreports'),\n                M.util.get_string('week_5', 'local_edwiserreports'),\n                M.util.get_string('week_6', 'local_edwiserreports')\n            ]\n        },\n        dataLabels: {\n            enabled: false\n        },\n        colors: [CFG.getColorTheme()[2]],\n    };\n\n    /**\n     * Load graph\n     */\n    function loadGraph(invalidUser) {\n        common.loader.show(SELECTOR.PANEL);\n\n        /**\n         * Render graph.\n         * @param {DOM} graph Graph element\n         * @param {Object} data Graph data\n         */\n        function renderGraph(graph, data) {\n            if (chart !== null) {\n                chart.destroy();\n            }\n            chart = new ApexCharts(graph.get(0), data);\n            chart.render();\n            setTimeout(function() {\n                common.loader.hide(SELECTOR.PANEL);\n            }, 1000);\n        }\n\n        PROMISE.GET_VISITSONSITE()\n            .done(function(response) {\n                if (response.error === true && response.exception.errorcode === 'invalidsecretkey') {\n                    invalidUser('siteaccessblock', response);\n                    return;\n                }\n                let data = Object.assign({}, heatmapChart);\n                data.series = response.data.siteaccess.reverse();\n                renderGraph($(SELECTOR.PANEL).find(SELECTOR.GRAPH), data);\n            }).fail(function(exception) {\n                common.loader.hide(SELECTOR.PANEL);\n            });\n    }\n\n    /**\n     * Generate shades of heatmap.\n     */\n    function generateShades() {\n        let opacity = 0;\n        let numberOfShades = 15;\n        let increment = 1 / (numberOfShades - 1);\n        for (let index = 1; index <= numberOfShades; index++) {\n            $(SELECTOR.SHADES).append(`<div class=\"shade\" style=\"opacity: ${opacity};\"><div class=\"shade-inner\"></div></div>`);\n            opacity += increment;\n        }\n        let width = 100 / numberOfShades;\n        $(SELECTOR.SHADES).find('.shade .shade-inner').css('background-color', CFG.getColorTheme()[2]);\n        $(SELECTOR.SHADES).find('.shade').css('width', width + '%');\n    }\n\n    /**\n     * Initialize\n     * @param {function} invalidUser Callback function\n     */\n    function init(invalidUser) {\n\n        if (!$(SELECTOR.PANEL).length) {\n            return;\n        }\n\n        loadGraph(invalidUser);\n\n        generateShades();\n\n        let filter = false;\n\n        // Export to PDF.\n        $(document).on(EdwiserReportsEvents.EXPORTGRAPHPDF + '-' + blockName, function() {\n            let graphElement = $(SELECTOR.PANEL).find('#apex-chart-siteaccess-block');\n            common.exportGraphPDF(chart, filter, graphElement.width(), graphElement.height());\n        });\n\n        // Export to JPEG.\n        $(document).on(EdwiserReportsEvents.EXPORTGRAPHJPEG + '-' + blockName, function() {\n            common.exportGraphJPEG(chart, filter);\n        });\n\n        // Export to PNG.\n        $(document).on(EdwiserReportsEvents.EXPORTGRAPHPNG + '-' + blockName, function() {\n            common.exportGraphPNG(chart, filter);\n        });\n\n        // Export to SVG.\n        $(document).on(EdwiserReportsEvents.EXPORTGRAPHSVG + '-' + blockName, function() {\n            common.exportGraphSVG(chart, filter);\n        });\n    }\n\n    // Must return the init function\n    return {\n        init: init\n    };\n});"],"file":"siteaccess.min.js"}
