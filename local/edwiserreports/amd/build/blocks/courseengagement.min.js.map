{"version":3,"sources":["blocks/courseengagement.js"],"names":["define","$","ModalFactory","ModalEvents","Fragment","CFG","common","SELECTOR","PANEL","COHORT","TABLE","SEARCH","FORMFILTER","USERS","MODALSEARCH","filter","cohort","dir","attr","dataTable","modalTable","PROMISE","GET_COURSEENGAGEMENT","ajax","url","requestUrl","type","requestType","dataType","requestDataType","data","action","secret","M","local_edwiserreports","lang","JSON","stringify","loadData","loader","show","done","response","destroy","DataTable","dom","columnDefs","className","targets","columns","width","info","language","infoEmpty","util","get_string","emptyTable","zeroRecords","paginate","previous","next","drawCallback","stylePaginationButton","this","fail","console","log","always","hide","init","invalidUser","val","length","find","select2","on","concat","search","draw","value","document","courseid","coursename","cohortid","ModalRoot","create","body","loadFragment","page","then","modal","getRoot","getBody","addClass","setTitle","hidden","shown","window","resize","bodyRendered","ModalTable","hasClass","empty","lengthChange"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n/**\n * Course Engagement block.\n *\n * @package     local_edwiserreports\n * @copyright   2022 Wisdmlabs <support@wisdmlabs.com>\n * @author      Yogesh Shirsath\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n/* eslint-disable no-console */\ndefine('local_edwiserreports/blocks/courseengagement', [\n    'jquery',\n    'core/modal_factory',\n    'core/modal_events',\n    'core/fragment',\n    'local_edwiserreports/defaultconfig',\n    'local_edwiserreports/common',\n], function(\n    $,\n    ModalFactory,\n    ModalEvents,\n    Fragment,\n    CFG,\n    common\n) {\n\n    /**\n     * Selectors.\n     */\n    var SELECTOR = {\n        PANEL: '#courseengagementblock',\n        COHORT: '.cohort-select',\n        TABLE: '#courseengagementblock table',\n        SEARCH: '.table-search-input input',\n        FORMFILTER: '#courseengagementblock .download-links [name=\"filter\"]',\n        USERS: '#courseengagementblock table a.modal-trigger',\n        MODALSEARCH: '.courseengage-modal .table-search-input input'\n    };\n\n    /**\n     * Filter.\n     */\n    var filter = {\n        cohort: 0,\n        dir: $('html').attr('dir')\n    };\n\n    /**\n     * Data table object.\n     */\n    var dataTable = null;\n\n    /**\n     * Table object of modal table.\n     */\n    var modalTable = null;\n\n    /**\n     * Promises list.\n     */\n    let PROMISE = {\n        /**\n         * Get timespent on site using filters.\n         * @param {Object} filter Filter data\n         * @returns {PROMISE}\n         */\n        GET_COURSEENGAGEMENT: function(filter) {\n            return $.ajax({\n                url: CFG.requestUrl,\n                type: CFG.requestType,\n                dataType: CFG.requestDataType,\n                data: {\n                    action: 'get_courseengagement_data_ajax',\n                    secret: M.local_edwiserreports.secret,\n                    lang: $('html').attr('lang'),\n                    data: JSON.stringify({\n                        filter: filter\n                    })\n                },\n            });\n        }\n    };\n\n    /**\n     * Load data to dataTable using ajax.\n     */\n    function loadData() {\n        // Show loader.\n        common.loader.show(SELECTOR.PANEL);\n\n        PROMISE.GET_COURSEENGAGEMENT(filter).done(function(response) {\n                if (dataTable !== null) {\n                    dataTable.destroy();\n                }\n                dataTable = $(SELECTOR.TABLE).DataTable({\n                    data: response.data,\n                    dom: '<\"edwiserreports-table\"<t><\"table-pagination\"p>>',\n                    columnDefs: [\n                        { className: \"fixed-column\", targets: 0 },\n                        { className: \"text-left\", targets: [0, 1] },\n                        { className: \"text-right\", targets: \"_all\" }\n                    ],\n                    columns: [\n                        { \"data\": \"coursename\", width: \"15rem\" },\n                        { \"data\": \"category\", width: \"17rem\" },\n                        { \"data\": \"enrolment\" },\n                        { \"data\": \"coursecompleted\" },\n                        { \"data\": \"completionspercentage\" },\n                        { \"data\": \"visited\" },\n                        { \"data\": \"averagevisits\" },\n                        { \"data\": \"timespent\" },\n                        { \"data\": \"averagetimespent\" }\n                    ],\n                    info: false,\n                    language: {\n                        infoEmpty: M.util.get_string('infoempty', 'local_edwiserreports'),\n                        emptyTable: M.util.get_string('nocourses', 'local_edwiserreports'),\n                        zeroRecords: M.util.get_string('zerorecords', 'local_edwiserreports'),\n                        paginate: {\n                            previous: \" \",\n                            next: \" \"\n                        }\n                    },\n                    drawCallback: function() {\n                        common.stylePaginationButton(this);\n                    }\n                });\n            })\n            .fail(function(data) {\n                console.log(data);\n            })\n            .always(function() {\n                // Hide loader.\n                common.loader.hide(SELECTOR.PANEL);\n            });\n\n    }\n\n    /**\n     * Initialize\n     * @param {function} invalidUser Callback function\n     */\n    function init(invalidUser) {\n\n        // Updated export filter values.\n        filter.dir = $('html').attr('dir');\n        $(SELECTOR.FORMFILTER).val(JSON.stringify(filter));\n\n        // Block not present on page.\n        if ($(SELECTOR.PANEL).length === 0) {\n            return;\n        }\n        // Enable select2 on cohort filter.\n        $(SELECTOR.PANEL).find('.singleselect').select2();\n\n        loadData();\n\n        // On change of cohort filter.\n        $('body').on('change', `${SELECTOR.PANEL} ${SELECTOR.COHORT}`, function() {\n            var cohort = $(this).val();\n            filter.cohort = cohort;\n            $(SELECTOR.PANEL).find('.download-links input[name=\"cohortid\"]').val(cohort);\n            loadData();\n        });\n\n        // Search in table.\n        $('body').on('input', `${SELECTOR.PANEL} ${SELECTOR.SEARCH}`, function() {\n            dataTable.columns(0).search($(this).val()).draw();\n        });\n\n        // Search in modal table.\n        $('body').on('input', SELECTOR.MODALSEARCH, function() {\n            modalTable.search(this.value).draw();\n        });\n\n        // Show users list in modal on number click.\n        $(document).on('click', SELECTOR.USERS, function() {\n            var action = $(this).data(\"action\");\n            var courseid = $(this).data(\"courseid\");\n            var coursename = $(this).data(\"coursename\");\n            var cohortid = $(SELECTOR.PANEL).find(SELECTOR.COHORT).length ? $(SELECTOR.PANEL).find(SELECTOR.COHORT).val() : 0;\n            var ModalRoot = null;\n\n            // eslint-disable-next-line promise/catch-or-return\n            ModalFactory.create({\n                body: Fragment.loadFragment(\n                    'local_edwiserreports',\n                    'userslist',\n                    1, {\n                        page: 'courseengage',\n                        courseid: courseid,\n                        action: action,\n                        cohortid: cohortid\n                    }\n                )\n            }).then(function(modal) {\n                ModalRoot = modal.getRoot();\n                modal.getBody().addClass('courseengage-modal');\n                ModalRoot.find('.modal-dialog').addClass('modal-lg');\n                modal.setTitle(coursename);\n                modal.show();\n                ModalRoot.on(ModalEvents.hidden, function() {\n                    modal.destroy();\n                });\n\n                ModalRoot.on(ModalEvents.shown, function() {\n                    $(window).resize();\n                });\n\n                ModalRoot.on(ModalEvents.bodyRendered, function() {\n                    var ModalTable = ModalRoot.find(\".modal-table\");\n\n                    // If empty then remove colspan\n                    if (ModalTable.find(\"tbody\").hasClass(\"empty\")) {\n                        ModalTable.find(\"tbody\").empty();\n                    }\n\n                    // Create dataTable for userslist\n                    modalTable = ModalTable.DataTable({\n                        language: {\n                            info: M.util.get_string('tableinfo', 'local_edwiserreports'),\n                            infoEmpty: M.util.get_string('infoempty', 'local_edwiserreports'),\n                            emptyTable: M.util.get_string('nousers', 'local_edwiserreports'),\n                            zeroRecords: M.util.get_string('zerorecords', 'local_edwiserreports'),\n                            paginate: {\n                                previous: \" \",\n                                next: \" \"\n                            }\n                        },\n                        dom: '<\"edwiserreports-table\"i<t><\"table-pagination\"p>>',\n                        drawCallback: function() {\n                            common.stylePaginationButton(this);\n                        },\n                        lengthChange: false\n                    });\n                });\n                return;\n            });\n        });\n    }\n\n    // Must return the init function\n    return {\n        init: init\n    };\n});\n"],"file":"courseengagement.min.js"}
