{"version":3,"sources":["blocks/learnertimespentonsite.js"],"names":["define","$","ApexCharts","Common","CFG","chart","filter","date","dir","attr","lineChartDefault","series","type","height","dropShadow","enabled","color","top","left","blur","opacity","toolbar","show","tools","download","reset","zoom","markers","size","tooltip","enabledOnSeries","undefined","shared","followCursor","intersect","inverseOrder","fillSeriesColor","onDatasetHover","highlightDataSeries","items","display","fixed","position","offsetX","offsetY","y","title","stroke","curve","width","grid","borderColor","xaxis","categories","labels","hideOverlappingLabels","datetimeFormatter","year","month","day","hour","legend","horizontalAlign","itemMargin","horizontal","vertical","dataLabels","colors","getColorTheme","pieChartDefault","noData","text","M","util","get_string","theme","monochrome","shadeTo","shadeIntensity","SELECTOR","PANEL","DATE","DATEMENU","DATEITEM","DATEPICKER","DATEPICKERINPUT","GRAPH","PROMISE","GET_TIMESPENTONSITE","ajax","url","requestUrl","requestType","dataType","requestDataType","data","action","secret","local_edwiserreports","lang","JSON","stringify","loadGraph","loader","done","response","includes","indexOf","Object","assign","yaxis","formatter","timeFormatter","dates","map","name","timespent","length","find","custom","_ref","seriesIndex","dataPointIndex","w","value","label","config","concat","graph","destroy","get","render","setTimeout","hide","renderGraph","fail","exception","initEvents","flatpickr","mode","altInput","altFormat","dateFormat","maxDate","appendTo","onOpen","addClass","onClose","removeClass","target","val","dateAlternate","next","stringarr","split","startdate","enddate","_startdate","css","direction","text-align","html","customDateSelected","on","this","init","invalidUser","currentDate"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n/**\n * Block service call and rendering defined in this file.\n *\n * @package     local_edwiserreports\n * @author      Yogesh Shirsath\n * @copyright   2022 wisdmlabs <support@wisdmlabs.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine('local_edwiserreports/blocks/learnertimespentonsite', [\n    'jquery',\n    'local_edwiserreports/vendor/apexcharts',\n    'local_edwiserreports/common',\n    'local_edwiserreports/defaultconfig',\n    'local_edwiserreports/select2'\n], function(\n    $,\n    ApexCharts,\n    Common,\n    CFG\n) {\n    /**\n     * Date picker.\n     */\n    var flatpickr = null;\n\n    /**\n     * Charts list.\n     */\n    var chart = null;\n\n    /**\n     * Filter for ajax.\n     */\n    var filter = {\n        date: 'last7days',\n        dir: $('html').attr('dir')\n    };\n\n    /**\n     * Line chart default config.\n     */\n    const lineChartDefault = {\n        series: [],\n        chart: {\n            type: 'line',\n            height: 350,\n            dropShadow: {\n                enabled: true,\n                color: '#000',\n                top: 18,\n                left: 7,\n                blur: 10,\n                opacity: 0.2\n            },\n            toolbar: {\n                show: false,\n                tools: {\n                    download: false,\n                    reset: '<i class=\"fa fa-refresh\"></i>'\n                }\n            },\n            zoom: {\n                enabled: false\n            }\n        },\n        markers: {\n            size: 0\n        },\n        tooltip: {\n            enabled: true,\n            enabledOnSeries: undefined,\n            shared: true,\n            followCursor: false,\n            intersect: false,\n            inverseOrder: false,\n            fillSeriesColor: false,\n            onDatasetHover: {\n                highlightDataSeries: false,\n            },\n            items: {\n                display: 'flex'\n            },\n            fixed: {\n                enabled: false,\n                position: 'topRight',\n                offsetX: 0,\n                offsetY: 0,\n            },\n            y: {\n                title: {}\n            }\n        },\n        stroke: {\n            curve: 'smooth',\n            width: 2\n        },\n        grid: {\n            borderColor: '#e7e7e7'\n        },\n        xaxis: {\n            categories: null,\n            type: 'datetime',\n            labels: {\n                hideOverlappingLabels: true,\n                datetimeFormatter: {\n                    year: 'yyyy',\n                    month: 'MMM \\'yy',\n                    day: 'dd MMM',\n                    hour: ''\n                }\n            },\n            tooltip: {\n                enabled: false\n            }\n        },\n        legend: {\n            position: 'top',\n            horizontalAlign: 'left',\n            offsetY: '-20',\n            itemMargin: {\n                horizontal: 10,\n                vertical: 0\n            },\n        },\n        dataLabels: {\n            enabled: false\n        },\n        colors: [CFG.getColorTheme()[2]]\n    };\n\n    /**\n     * Pie chart default config.\n     */\n    const pieChartDefault = {\n        chart: {\n            type: 'donut',\n            height: 350\n        },\n        legend: {\n            position: 'bottom',\n            offsetY: 0\n        },\n        noData: {\n            text: M.util.get_string('nographdata', 'local_edwiserreports')\n        },\n        theme: {\n            monochrome: {\n                enabled: true,\n                color: CFG.getColorTheme()[2],\n                shadeTo: 'light',\n                shadeIntensity: 0.65\n            },\n        }\n    };\n\n    /**\n     * Selectors list.\n     */\n    var SELECTOR = {\n        PANEL: '#learnertimespentonsiteblock',\n        DATE: '.learnertimespentonsite-calendar',\n        DATEMENU: '.learnertimespentonsite-calendar + .dropdown-menu',\n        DATEITEM: '.learnertimespentonsite-calendar + .dropdown-menu .dropdown-item',\n        DATEPICKER: '.learnertimespentonsite-calendar + .dropdown-menu .dropdown-calendar',\n        DATEPICKERINPUT: '.learnertimespentonsite-calendar + .dropdown-menu .flatpickr',\n        GRAPH: '#apex-chart-learnertimespentonsite-block',\n    };\n\n    /**\n     * All promises.\n     */\n    var PROMISE = {\n        /**\n         * Get timespent on site using filters.\n         * @param {Object} filter Filter data\n         * @returns {PROMISE}\n         */\n        GET_TIMESPENTONSITE: function(filter) {\n            return $.ajax({\n                url: CFG.requestUrl,\n                type: CFG.requestType,\n                dataType: CFG.requestDataType,\n                data: {\n                    action: 'get_learnertimespentonsite_graph_data_ajax',\n                    secret: M.local_edwiserreports.secret,\n                    lang: $('html').attr('lang'),\n                    data: JSON.stringify({\n                        filter: filter\n                    })\n                },\n            });\n        },\n    }\n\n    /**\n     * Load graph\n     */\n    function loadGraph() {\n        Common.loader.show(SELECTOR.PANEL);\n\n        /**\n         * Render graph.\n         * @param {DOM} graph Graph element\n         * @param {Object} data Graph data\n         */\n        function renderGraph(graph, data) {\n            if (chart !== null) {\n                chart.destroy();\n            }\n            chart = new ApexCharts(graph.get(0), data);\n            chart.render();\n            setTimeout(function() {\n                Common.loader.hide(SELECTOR.PANEL);\n            }, 1000);\n        }\n        PROMISE.GET_TIMESPENTONSITE(filter)\n            .done(function(response) {\n                let data;\n                if (filter.date.includes(\" to \") || ['last7days', 'weekly', 'monthly', 'yearly'].indexOf(filter.date) !== -1) {\n                    data = Object.assign({}, lineChartDefault);\n                    data.yaxis = {\n                        labels: {\n                            formatter: Common.timeFormatter\n                        }\n                    };\n                    data.xaxis.categories = response.dates.map(date => date * 86400000);\n                    data.series = [{\n                        name: M.util.get_string('timespentonlms', 'local_edwiserreports'),\n                        data: response.timespent,\n                    }];\n                    data.chart.toolbar.show = response.dates.length > 29;\n                    data.chart.zoom.enabled = response.dates.length > 29;\n                    data.tooltip.y.title.formatter = (title) => {\n                        return M.util.get_string('time', 'local_edwiserreports') + ': ';\n                    }\n                    $(SELECTOR.PANEL).find('.panel-body').attr('data-charttype', 'line');\n                } else {\n                    data = Object.assign({}, pieChartDefault);\n                    data.labels = response.labels;\n                    data.series = response.timespent;\n                    data.tooltip = {\n                        custom: function({ series, seriesIndex, dataPointIndex, w }) {\n                            let value = Common.timeFormatter(series[seriesIndex], {\n                                dataPointIndex: dataPointIndex\n                            });\n                            let label = w.config.labels[seriesIndex];\n                            return `<div class=\"custom-donut-tooltip theme-2-text\">\n                                    <span style=\"font-weight: 500;\"> ${label}:</span>\n                                    <span style=\"font-weight: 700;\"> ${value} </span>\n                                </div>`;\n                        }\n                    };\n                    data.legend = {\n                        show: false\n                    };\n                    $(SELECTOR.PANEL).find('.panel-body').attr('data-charttype', 'donut');\n                }\n                renderGraph($(SELECTOR.PANEL).find(SELECTOR.GRAPH), data);\n                Common.loader.hide(SELECTOR.PANEL);\n            }).fail(function(exception) {\n                Common.loader.hide(SELECTOR.PANEL);\n            });\n    }\n\n    /**\n     * After Select Custom date get active users details.\n     * @param {String} target Targeted graph\n     */\n    function customDateSelected(target) {\n        let date = $(SELECTOR.PANEL).find(SELECTOR.DATEPICKERINPUT).val(); // Y-m-d format\n        let dateAlternate = $(SELECTOR.PANEL).find(SELECTOR.DATEPICKERINPUT).next().val(); // d/m/Y format\n\n        /* If correct date is not selected then return false */\n        if (date == '') {\n            return;\n        }\n\n        // RTL support\n        \n        // Formating date for rtl\n        if(filter.dir == 'rtl'){\n            // Split string in 2 parts\n            if(dateAlternate.includes('to')){\n                let stringarr = dateAlternate.split('to');\n                // format for rtl : yyyy mm dd\n                let startdate = stringarr[0].split('/');\n                let enddate = stringarr[1].split('/');\n\n                startdate = startdate[2] + '/' + startdate[1] + '/' + startdate[0];\n                enddate = enddate[2] + '/' + enddate[1] + '/' + enddate[0];\n                dateAlternate = enddate + '-' + startdate;\n            } else{\n                // format for rtl : yyyy mm dd\n                let startdate = dateAlternate.split('/');\n\n                startdate = startdate[2] + '/' + startdate[1] + '/' + startdate[0];\n                dateAlternate = startdate;\n            }\n\n            // Making direction ltr for date selector and aligning text to right\n            $(SELECTOR.DATE).css({'direction':'ltr','text-align': 'right'});\n            $(SELECTOR.DATEPICKERINPUT).css({'direction':'ltr','text-align': 'right'});\n        }\n\n\n        // Set active class to custom date selector item.\n        $(SELECTOR.PANEL).find(SELECTOR.DATEITEM).removeClass('active');\n        $(SELECTOR.PANEL).find(SELECTOR.DATEITEM + '.custom').addClass('active');\n\n        // Show custom date to dropdown button.\n        $(SELECTOR.PANEL).find(SELECTOR.DATE).html(dateAlternate);\n        filter.date = date;\n        loadGraph(target);\n    }\n\n    /**\n     * Initialize event listeners.\n     */\n    function initEvents() {\n\n        flatpickr = $(SELECTOR.PANEL).find(SELECTOR.DATEPICKERINPUT).flatpickr({\n            mode: 'range',\n            altInput: true,\n            altFormat: \"d/m/Y\",\n            dateFormat: \"Y-m-d\",\n            maxDate: \"today\",\n            appendTo: $(SELECTOR.PANEL).find(SELECTOR.DATEPICKER).get(0),\n            onOpen: function() {\n                $(SELECTOR.PANEL).find(SELECTOR.DATEMENU).addClass('withcalendar');\n            },\n            onClose: function() {\n                $(SELECTOR.PANEL).find(SELECTOR.DATEMENU).removeClass('withcalendar');\n                customDateSelected();\n            }\n        });\n\n        /* Date selector listener */\n        $('body').on('click', SELECTOR.DATEITEM + \":not(.custom)\", function() {\n            // Set custom selected item as active.\n            $(SELECTOR.PANEL).find(SELECTOR.DATEITEM).removeClass('active');\n            $(this).addClass('active');\n\n            // Show selected item on dropdown button.\n            $(SELECTOR.PANEL).find(SELECTOR.DATE).html($(this).text());\n\n            // Set date.\n            filter.date = $(this).data('value');\n\n            // Load graph data.\n            loadGraph();\n        });\n    }\n\n    /**\n     * Initialize\n     * @param {function} invalidUser Callback function\n     * @param {String}   currentDate Current active date\n     */\n    function init(invalidUser, currentDate) {\n\n        // Assigning current date.\n        filter.date = currentDate;\n\n        if ($(SELECTOR.PANEL).length == 0) {\n            return;\n        }\n\n        initEvents();\n\n        loadGraph();\n    }\n    return {\n        init: init\n    };\n});\n"],"file":"learnertimespentonsite.min.js"}
