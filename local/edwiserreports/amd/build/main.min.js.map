{"version":3,"sources":["main.js"],"names":["define","$","ModalFactory","Notification","EdwiserReportsEvents","common","email","CFG","insights","Migration","siteAccess","activeCourses","activeUsers","courseProgress","inactiveUsers","realTimeUsers","todaysActivity","grade","visitsonsite","timespentonsite","timespentoncourse","courseactivitystatus","learnercourseprogress","learnertimespentonsite","courseengagement","certificatestats","SELECTOR","ROOT","EXPORT","DATESELECTED","DATE","DATEMENU","DATEITEM","DATEPICKER","DATEPICKERINPUT","PROMISE","GET_TIMEPERIOD_LABEL","timeperiod","ajax","url","requestUrl","type","requestType","dataType","requestDataType","data","action","secret","M","local_edwiserreports","lang","attr","GET_EXPORT_DATA_FOR_GRAPH","download","blocks","flatpickr","validateUser","blockid","response","concat","html","exception","message","showTimeLabel","date","done","startdate","Date","enddate","startDay","getDate","endDay","customdate","toLocaleString","month","getFullYear","css","direction","text-align","fail","ex","throwDateEvent","label","dateChangeEvent","CustomEvent","DATECHANGE","detail","document","dispatchEvent","init","ready","currentDate","text","handleSearchInput","forEach","block","mode","altInput","altFormat","dateFormat","maxDate","appendTo","get","onOpen","addClass","dropdown","onClose","removeClass","val","dateAlternate","next","replace","dirattr","stringarr","split","trim","includes","clear","customDateSelected","on","this","exportDropdownHandler","initMigration","create","TYPE","format","filename","require","amd"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n/**\n * Plugin administration pages are defined here.\n *\n * @package     local_edwiserreports\n * @copyright   2022 Wisdmlabs <support@wisdmlabs.com>\n * @author      Yogesh Shirsath\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'jquery',\n    'core/modal_factory',\n    'core/notification',\n    './events',\n    './common',\n    './email',\n    './defaultconfig',\n    './insights',\n    './modal-migration',\n    './blocks/siteaccess',\n    './blocks/activecourses',\n    './blocks/activeusers',\n    './blocks/courseprogress',\n    './blocks/inactiveusers',\n    './blocks/realtimeusers',\n    './blocks/todaysactivity',\n    './blocks/grade',\n    './blocks/visitsonsite',\n    './blocks/timespentonsite',\n    './blocks/timespentoncourse',\n    './blocks/courseactivitystatus',\n    './blocks/learnercourseprogress',\n    './blocks/learnertimespentonsite',\n    './blocks/courseengagement',\n    './blocks/certificatestats'\n], function(\n    $,\n    ModalFactory,\n    Notification,\n    EdwiserReportsEvents,\n    common,\n    email,\n    CFG,\n    insights,\n    Migration,\n    siteAccess,\n    activeCourses,\n    activeUsers,\n    courseProgress,\n    inactiveUsers,\n    realTimeUsers,\n    todaysActivity,\n    grade,\n    visitsonsite,\n    timespentonsite,\n    timespentoncourse,\n    courseactivitystatus,\n    learnercourseprogress,\n    learnertimespentonsite,\n    courseengagement,\n    certificatestats\n) {\n\n    /**\n     * Selector list.\n     */\n    var SELECTOR = {\n        ROOT: '#wdm-edwiserreports',\n        EXPORT: '#wdm-edwiserreports .export-options',\n        DATESELECTED: '.selected-period',\n        DATE: '.edwiserreports-header .edwiserreports-calendar',\n        DATEMENU: '.edwiserreports-header .edwiserreports-calendar + .dropdown-menu',\n        DATEITEM: '.edwiserreports-header .edwiserreports-calendar + .dropdown-menu .dropdown-item',\n        DATEPICKER: '.edwiserreports-header .edwiserreports-calendar + .dropdown-menu .dropdown-calendar',\n        DATEPICKERINPUT: '.edwiserreports-header .edwiserreports-calendar + .dropdown-menu .flatpickr'\n    };\n\n    /**\n     * Promises.\n     */\n    var PROMISE = {\n        /**\n         * Get time period label to show in the header.\n         * @param {String} timeperiod Time period.\n         * @returns {Promise}\n         */\n        GET_TIMEPERIOD_LABEL: function(timeperiod) {\n            return $.ajax({\n                url: CFG.requestUrl,\n                type: CFG.requestType,\n                dataType: CFG.requestDataType,\n                data: {\n                    action: 'get_timeperiod_label_data_ajax',\n                    secret: M.local_edwiserreports.secret,\n                    lang: $('html').attr('lang'),\n                    data: timeperiod\n                }\n            });\n        },\n\n        /**\n         * Get data for graph export using download key.\n         * @param {String} download Download key for graph records\n         * @returns {Promise}\n         */\n        GET_EXPORT_DATA_FOR_GRAPH: function(download) {\n            return $.ajax({\n                url: CFG.requestUrl,\n                type: CFG.requestType,\n                dataType: CFG.requestDataType,\n                data: {\n                    action: 'get_export_data_for_graph',\n                    lang: $('html').attr('lang'),\n                    download: download\n                }\n            })\n        }\n    };\n\n    /**\n     * Blocks list.\n     */\n    var blocks = [\n        siteAccess,\n        activeCourses,\n        activeUsers,\n        courseProgress,\n        inactiveUsers,\n        realTimeUsers,\n        todaysActivity,\n        grade,\n        visitsonsite,\n        timespentonsite,\n        timespentoncourse,\n        courseactivitystatus,\n        learnercourseprogress,\n        learnertimespentonsite,\n        courseengagement,\n        certificatestats\n    ];\n\n    /**\n     * Flat picker custom date.\n     */\n    let flatpickr = null;\n\n    /**\n     * This function will show validation error in block card.\n     * @param {String} blockid Block id\n     * @param {Object} response User validation response\n     */\n    function validateUser(blockid, response) {\n        $(`#${blockid} .panel-body`).html(response.exception.message);\n    }\n\n    /**\n     * Show time duration in header.\n     * @param {String} date Time period.\n     */\n    function showTimeLabel(date) {\n        PROMISE.GET_TIMEPERIOD_LABEL(date).done(function(response) {\n            let startdate = new Date(response.startdate * 86400000);\n            let enddate = new Date(response.enddate * 86400000);\n            let startDay = startdate.getDate();\n            startDay = startDay < 10 ? '0' + startDay : startDay;\n            let endDay = enddate.getDate();\n            endDay = endDay < 10 ? '0' + endDay : endDay;\n\n            let customdate = `${startDay} ${startdate.toLocaleString('default', { month: 'long' })} ${startdate.getFullYear()}` + ' - ' +\n            `${endDay} ${enddate.toLocaleString('default', { month: 'long' })} ${enddate.getFullYear()}`;\n            // RTL support\n            let dirattr = $('html').attr('dir');\n            // Formating date for rtl\n            if(dirattr == 'rtl'){\n                // format for rtl : yyyy mm dd\n\n                startdate = startdate.getFullYear() + ' ' + startdate.toLocaleString('default', { month: 'long' }) + ' ' + startDay;\n                enddate = enddate.getFullYear() + ' ' + enddate.toLocaleString('default', { month: 'long' }) + ' ' + endDay;\n                customdate = enddate + '-' + startdate;\n                \n\n                // Making direction ltr for date selector and aligning text to right\n                $(SELECTOR.DATE).css({'direction':'ltr','text-align': 'right'});\n                $(SELECTOR.DATEPICKERINPUT).css({'direction':'ltr','text-align': 'right'});\n            }\n\n            $(SELECTOR.DATESELECTED).html(customdate);\n\n            // $(SELECTOR.DATESELECTED).html('<div style=\"display:flex;\"><div>' + `${startDay} ${startdate.toLocaleString('default', { month: 'long' })} ${startdate.getFullYear()}` + '</div> - <div>' +\n            // `${endDay} ${enddate.toLocaleString('default', { month: 'long' })} ${enddate.getFullYear()}` + '</div></div>');\n\n        }).fail(function(ex) {\n            Notification.exception(ex);\n        });\n    }\n\n    /**\n     * Throw an event with date change data.\n     * @param {String} date  Date\n     * @param {String} label Date label\n     */\n    function throwDateEvent(date, label) {\n        let dateChangeEvent = new CustomEvent(EdwiserReportsEvents.DATECHANGE, {\n            detail: {\n                date: date\n            }\n        });\n        document.dispatchEvent(dateChangeEvent);\n        showTimeLabel(date, label);\n    }\n\n    /**\n     * After Select Custom date get active users details.\n     */\n    function customDateSelected() {\n        let date = $(SELECTOR.DATEPICKERINPUT).val(); // Y-m-d format\n        let dateAlternate = $(SELECTOR.DATEPICKERINPUT).next().val().replace(\"to\", \"-\"); // d M Y format\n\n        // RTL support\n        let dirattr = $('html').attr('dir');\n        // Split string in 2 parts\n        let stringarr = dateAlternate.split('-');\n        // Formating date for rtl\n        if(dirattr == 'rtl'){\n            // format for rtl : yyyy mm dd\n            let startdate = stringarr[0].split(' ');\n            let enddate = stringarr[1].split(' ');\n\n            startdate = startdate[2] + ' ' + startdate[1] + ' ' + startdate[0];\n            enddate = enddate[3] + ' ' + enddate[2] + ' ' + enddate[1];\n            dateAlternate = enddate + '-' + startdate;\n\n            // Making direction ltr for date selector and aligning text to right\n            $(SELECTOR.DATE).css({'direction':'ltr','text-align': 'right'});\n            $(SELECTOR.DATEPICKERINPUT).css({'direction':'ltr','text-align': 'right'});\n        }\n\n        $(SELECTOR.DATEPICKERINPUT).next().val($.trim(dateAlternate));\n\n        /* If correct date is not selected then return false */\n        if (!date.includes(\" to \")) {\n            flatpickr.clear();\n            return;\n        }\n\n        // Set active class to custom date selector item.\n        $(SELECTOR.DATEITEM).removeClass('active');\n        $(SELECTOR.DATEITEM + '.custom').addClass('active');\n\n        // Show custom date to dropdown button.\n        $(SELECTOR.DATE).html(dateAlternate);\n\n        // Throw date change event.\n        throwDateEvent(date, dateAlternate);\n    }\n\n    /**\n     * Init main.js\n     */\n    var init = function() {\n        $(document).ready(function() {\n\n            // Initialize schedule email modal.\n            email.init();\n\n            // Initialize insights.\n            insights.init();\n\n            let currentDate = $(SELECTOR.DATEITEM + '.active').data('value');\n\n            // Show time period in header.\n            showTimeLabel(\n                currentDate,\n                $(SELECTOR.DATEITEM + '.active').text()\n            );\n\n            common.handleSearchInput();\n\n            blocks.forEach(block => {\n                block.init(validateUser, currentDate);\n            });\n\n            flatpickr = $(SELECTOR.DATEPICKERINPUT).flatpickr({\n                mode: 'range',\n                altInput: true,\n                altFormat: \"d M Y\",\n                dateFormat: \"Y-m-d\",\n                maxDate: \"today\",\n                appendTo: $(SELECTOR.DATEPICKER).get(0),\n                onOpen: function() {\n                    $(SELECTOR.DATEMENU).addClass('withcalendar');\n                    $(SELECTOR.DATE).dropdown('update');\n                },\n                onClose: function() {\n                    $(SELECTOR.DATEMENU).removeClass('withcalendar');\n                    customDateSelected();\n                }\n            });\n\n            /* Date selector listener */\n            $('body').on('click', SELECTOR.DATEITEM + \":not(.custom)\", function() {\n                // Set custom selected item as active.\n                $(SELECTOR.DATEITEM).removeClass('active');\n                $(this).addClass('active');\n\n                // Show selected item on dropdown button.\n                $(SELECTOR.DATE).html($(this).text());\n\n                // Clear custom date.\n                flatpickr.clear();\n\n                // Throw date change event.\n                throwDateEvent($(this).data('value'), $(this).text());\n            });\n\n            common.exportDropdownHandler(SELECTOR.EXPORT);\n        });\n    };\n\n    function initMigration() {\n        ModalFactory.create({\n            type: Migration.TYPE\n        }, $('#create'));\n    }\n\n    /**\n     * Download graph as image.\n     * @param {String} download Download key\n     * @param {String} block    Block name\n     * @param {String} format   Exporting format\n     * @param {String} filename Exporting filename\n     */\n    function download(download, block, format, filename) {\n        $(document).ready(function() {\n            require(['local_edwiserreports/blocks/' + block], function(amd) {\n                PROMISE.GET_EXPORT_DATA_FOR_GRAPH(download)\n                    .done(function(response) {\n                        amd.download(format, filename, response);\n                    });\n            });\n        });\n    }\n\n    // Must return the init function\n    return {\n        init: init,\n        initMigration: initMigration,\n        download: download\n    };\n});\n"],"file":"main.min.js"}
